# КОНЦЕПЦИЯ: UnMoGrowP Agents + ChatGPT Integration
# Расширение существующего AI Monitor для анализа agent data

name: 🤖 Agent Intelligence with ChatGPT

on:
  workflow_dispatch:
    inputs:
      agent_type:
        description: 'Which agent data to analyze'
        required: true
        type: choice
        options:
        - attribution
        - fraud_detection
        - revenue_optimization
        - customer_success
        - all_agents

jobs:
  agent-intelligence:
    runs-on: ubuntu-latest

    steps:
      - name: 🔍 Checkout Repository
        uses: actions/checkout@v3

      - name: 📊 Collect Agent Data
        run: |
          # Пример: получение данных от агентов UnMoGrowP
          echo "Collecting agent data for: ${{ github.event.inputs.agent_type }}"

          # Attribution Agent Data
          if [[ "${{ github.event.inputs.agent_type }}" == "attribution" || "${{ github.event.inputs.agent_type }}" == "all_agents" ]]; then
            echo "📈 Attribution Metrics:" >> /tmp/agent_data.md
            echo "- Total Attributions: 1.2M this month" >> /tmp/agent_data.md
            echo "- Top Performing Channels: Google Ads (35%), Facebook (28%)" >> /tmp/agent_data.md
            echo "- Average Attribution Path Length: 3.2 touchpoints" >> /tmp/agent_data.md
            echo "- Customer LTV: \$284 average" >> /tmp/agent_data.md
            echo "" >> /tmp/agent_data.md
          fi

          # Fraud Detection Agent Data
          if [[ "${{ github.event.inputs.agent_type }}" == "fraud_detection" || "${{ github.event.inputs.agent_type }}" == "all_agents" ]]; then
            echo "🛡️ Fraud Detection Results:" >> /tmp/agent_data.md
            echo "- Fraud Rate: 0.8% (down from 1.2% last month)" >> /tmp/agent_data.md
            echo "- Blocked Fraudulent Clicks: 15K" >> /tmp/agent_data.md
            echo "- Top Fraud Patterns: Click farms (45%), Bot traffic (32%)" >> /tmp/agent_data.md
            echo "- Saved Ad Spend: \$28K this month" >> /tmp/agent_data.md
            echo "" >> /tmp/agent_data.md
          fi

      - name: 🤖 ChatGPT Agent Analysis
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "⚠️ OPENAI_API_KEY not configured"
            exit 0
          fi

          AGENT_DATA=$(cat /tmp/agent_data.md)

          HTTP_STATUS=$(curl -w "%{http_code}" -s -X POST "https://api.openai.com/v1/chat/completions" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "model": "gpt-4o-mini",
              "messages": [
                {
                  "role": "system",
                  "content": "You are an expert analyst for UnMoGrowP attribution platform. Analyze agent data and provide actionable business insights, optimization recommendations, and strategic advice for competing against AppsFlyer and Adjust."
                },
                {
                  "role": "user",
                  "content": "Analyze this agent data: '"$AGENT_DATA"'"
                }
              ],
              "max_tokens": 1000,
              "temperature": 0.2
            }' \
            -o /tmp/agent_analysis.json)

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "✅ Agent Intelligence Analysis received"
            mkdir -p attribution/docs/agent-intelligence
            echo "# 🤖 Agent Intelligence Report - $(date +%Y-%m-%d)" > "attribution/docs/agent-intelligence/$(date +%Y-%m-%d)_${{ github.event.inputs.agent_type }}_analysis.md"
            echo "" >> "attribution/docs/agent-intelligence/$(date +%Y-%m-%d)_${{ github.event.inputs.agent_type }}_analysis.md"
            grep -o '"content":"[^"]*"' /tmp/agent_analysis.json | sed 's/"content":"//;s/"$//' >> "attribution/docs/agent-intelligence/$(date +%Y-%m-%d)_${{ github.event.inputs.agent_type }}_analysis.md"
          else
            echo "❌ Agent analysis failed with HTTP: $HTTP_STATUS"
          fi

      - name: 💾 Commit Agent Intelligence
        run: |
          git config user.name "Agent Intelligence Bot"
          git config user.email "agents@unmogrowp.com"
          git add attribution/docs/agent-intelligence/
          if ! git diff --staged --quiet; then
            git commit -m "🤖 Agent Intelligence Report - ${{ github.event.inputs.agent_type }} analysis $(date +%Y-%m-%d)"
            git push
          fi